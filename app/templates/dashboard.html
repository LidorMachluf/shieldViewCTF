{% extends "base.html" %}

{% block title %}Dashboard — ShieldView SOC{% endblock %}

{% block content %}
<div class="page-header dashboard-page">
    <h1>Security Alerts</h1>
    <div class="flex items-center gap-3">
        <button class="btn btn-secondary" onclick="exportCSV()" data-tooltip="Export alerts as CSV">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export CSV
        </button>
    </div>
</div>

<div class="page-content">
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-label">Total Alerts</div>
            <div class="stat-value">{{ total }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">High Severity</div>
            <div class="stat-value high">{{ stats.high }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Medium Severity</div>
            <div class="stat-value medium">{{ stats.medium }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Low Severity</div>
            <div class="stat-value low">{{ stats.low }}</div>
        </div>
    </div>

    <div class="card">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 70px;">
                        <a href="{{ url_for('alerts.dashboard', page=page, sort='id', order='asc' if sort == 'id' and order == 'desc' else 'desc') }}">
                            ID {% if sort == 'id' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                        </a>
                    </th>
                    <th style="width: 100px;">
                        <a href="{{ url_for('alerts.dashboard', page=page, sort='severity', order='asc' if sort == 'severity' and order == 'desc' else 'desc') }}">
                            Severity {% if sort == 'severity' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="{{ url_for('alerts.dashboard', page=page, sort='title', order='asc' if sort == 'title' and order == 'desc' else 'desc') }}">
                            Title {% if sort == 'title' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                        </a>
                    </th>
                    <th>Asset</th>
                    <th>
                        <a href="{{ url_for('alerts.dashboard', page=page, sort='source_ip', order='asc' if sort == 'source_ip' and order == 'desc' else 'desc') }}">
                            Source IP {% if sort == 'source_ip' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                        </a>
                    </th>
                    <th style="width: 160px;">
                        <a href="{{ url_for('alerts.dashboard', page=page, sort='created_at', order='asc' if sort == 'created_at' and order == 'desc' else 'desc') }}">
                            Timestamp {% if sort == 'created_at' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for alert in alerts %}
                <tr class="clickable" onclick="window.location='{{ url_for('alerts.alert_detail', alert_id=alert.id) }}'">
                    <td><span class="mono text-muted">#{{ alert.id }}</span></td>
                    <td>
                        <span class="badge badge-{{ alert.severity | lower }}">{{ alert.severity }}</span>
                    </td>
                    <td>{{ alert.title }}</td>
                    <td>
                        <span class="mono">{{ alert.asset_hostname }}</span>
                    </td>
                    <td>
                        <span class="mono">{{ alert.source_ip }}</span>
                    </td>
                    <td>
                        <span class="mono text-secondary">{{ alert.created_at[:16] | replace('T', ' ') if 'T' in (alert.created_at or '') else alert.created_at }}</span>
                    </td>
                </tr>
                {% endfor %}
                {% if not alerts %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No alerts found.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if total_pages > 1 %}
    <div class="pagination">
        <div class="text-secondary">Showing {{ (page - 1) * 10 + 1 }}–{{ [page * 10, total] | min }} of {{ total }} alerts</div>
        <div class="page-links">
            <a href="{{ url_for('alerts.dashboard', page=page-1, sort=sort, order=order) }}" class="page-link {% if page <= 1 %}disabled{% endif %}">&laquo; Prev</a>
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <span class="page-link active">{{ p }}</span>
                {% elif p <= 3 or p >= total_pages - 1 or (p >= page - 1 and p <= page + 1) %}
                <a href="{{ url_for('alerts.dashboard', page=p, sort=sort, order=order) }}" class="page-link">{{ p }}</a>
                {% elif p == 4 or p == total_pages - 2 %}
                <span class="page-link" style="border: none;">&hellip;</span>
                {% endif %}
            {% endfor %}
            <a href="{{ url_for('alerts.dashboard', page=page+1, sort=sort, order=order) }}" class="page-link {% if page >= total_pages %}disabled{% endif %}">Next &raquo;</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
